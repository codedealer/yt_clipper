<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>yt_clipper Editor</title>
    <link
      href="https://cdn.jsdelivr.net/npm/video.js@8.22.0/dist/video-js.min.css"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #000;
      }

      #ytc-media-player-container {
        height: 80vh;
        width: 98vw;
        background-color: #000;
        margin-left: 1vw;
        margin-right: 1vw;
        padding-bottom: 35px;
        position: relative;
      }

      #ytc-video-title {
        color: white;
        padding: 2px;
        margin-left: 1vw;
        margin-right: 1vw;
      }

      /* Apply to raw <video> elements */
      video:focus-visible {
        outline: none !important;
        box-shadow: none !important;
      }

      /* Apply to Video.js' tech element */
      .vjs-tech:focus-visible {
        outline: none !important;
        box-shadow: none !important;
      }

      media-player,
      #my-video {
        width: 100%;
        height: 100%;
        display: block;
      }

      .vjs-volume-panel.vjs-hover {
        width: auto !important; /* Prevents it from collapsing */
        opacity: 1 !important; /* Forces it visible */
        visibility: visible !important;
      }
      .vjs-volume-panel {
        width: auto !important;
      }

      .video-js .vjs-remaining-time {
        display: none !important;
      }

      .video-js .vjs-duration {
        display: inline-block !important;
      }

      .video-js .vjs-current-time {
        display: inline-block !important;
      }

      .video-js .vjs-control-bar {
        background-color: rgba(43, 51, 63, 0);
      }

      .video-js .vjs-control-bar {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row;
      }

      .video-js .vjs-progress-control {
        order: -1; /* Move to top */
        width: 100%;
        margin-bottom: 5px; /* spacing from the rest */
      }
      .video-js .vjs-progress-control .vjs-progress-holder {
        margin: 0;
      }

      .video-js .vjs-slider {
        margin: 0;
      }
      /* Override default hiding behavior */
      .video-js.vjs-user-inactive .vjs-control-bar {
        opacity: 0;
        transition: opacity 0.4s ease;
        pointer-events: none; /* Optional: avoid interaction when hidden */
      }

      /* Ensure control bar is visible when user is active */
      .video-js .vjs-control-bar {
        opacity: 1;
        transition: opacity 0.4s ease;
      }
    </style>
    <script>
      document.addEventListener('drop', handleDrop);
      document.addEventListener('dragover', (e) => e.preventDefault());
      document.addEventListener('paste', handlePaste);

      function handlePaste(e) {
        e.preventDefault();

        const clipboardData = e.clipboardData || window.clipboardData;
        const url = clipboardData.getData('text');

        document.querySelector('video').src = url;
        document.querySelector('#ytc-video-title').textContent = url;
        installVideojs();

        document.removeEventListener('paste', handlePaste);
      }

      function handleDrop(e) {
        e.preventDefault();
        const videoLoaded = loadVideo(e);
        if (videoLoaded) {
          installVideojs();
          document.removeEventListener('drop', handleDrop);
        }
      }

      function loadVideo(e) {
        let videoLoaded = false;

        const file = e.dataTransfer.files?.[0];
        const data = e.dataTransfer.getData('text/plain');

        if (file && file.type.startsWith('video/')) {
          const url = URL.createObjectURL(file);
          document.querySelector('video').src = url;
          document.querySelector('#ytc-video-title').textContent = file.name;
          videoLoaded = true;
        } else if (!data.includes('\n') && data.endsWith('.m3u8')) {
          loadHlsVideo(data);
          videoLoaded = true;
        } else if (data) {
          const links = data.split('\n', 2);
          const videoM3U8 = links[0].trim();
          const audioM3U8 = links[1].trim();

          const masterPlaylist = `#EXTM3U
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="aac",NAME="Default",DEFAULT=YES,AUTOSELECT=YES,URI="${audioM3U8}"
#EXT-X-STREAM-INF:BANDWIDTH=1500000,CODECS="avc1.640034",AUDIO="aac"
${videoM3U8}
`;

          const blob = new Blob([masterPlaylist], { type: 'application/vnd.apple.mpegurl' });
          const masterUrl = URL.createObjectURL(blob);

          loadHlsVideo(masterUrl);
          videoLoaded = true;
        }

        return videoLoaded;
      }

      function loadHlsVideo(hlsUrl) {
        const video = document.getElementById('my-video');

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(hlsUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = hlsUrl;
          video.addEventListener('loadedmetadata', () => video.play());
        }
      }

      function installVideojs() {
        videojs('my-video', {
          playbackRates: [0.25, 0.5, 1, 1.25, 1.5, 1.75, 2],
          enableSmoothSeeking: true,
          userInactiveTimeout: 0,
          controlBar: {},
        });
      }
    </script>
  </head>
  <body>
    <div id="ytc-media-player-container">
      <video
        id="my-video"
        class="video-js vjs-default-skin"
        controls
        preload="auto"
        width="100%"
        height="100%"
      >
        <p class="vjs-no-js">
          To view this video please enable JavaScript, and consider upgrading to a web browser that
          <a href="https://videojs.com/html5-video-support/" target="_blank"
            >supports HTML5 video</a
          >
        </p>
      </video>
    </div>

    <div id="ytc-editor"></div>

    <h2 id="ytc-video-title">
      To load a video, drag and drop it onto the player OR paste a direct video URL anywhere (e.g. with ctrl+v). Then activate the markup user script.
    </h2>

    <script src="https://cdn.jsdelivr.net/npm/video.js@8.22.0/dist/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.2/dist/hls.min.js"></script>
  </body>
</html>
